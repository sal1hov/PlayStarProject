{% extends 'staff/base_admin.html' %}
{% load static %}
{% load widget_tweaks %}

{% block admin_content %}
<div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-8">
    <h2 class="text-3xl font-bold text-gray-800 text-center mb-8 border-b pb-4">
        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã
    </h2>

    {% if forms %}
    <form method="post" class="space-y-10">
        {% csrf_token %}
        <div id="shift-container">
            {% for shift, form in forms %}
                {% include 'staff/common/partials/shift_card.html' with shift=shift form=form %}
            {% endfor %}
        </div>

        <div class="text-right mt-6">
            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2.5 rounded-lg shadow transition">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
        </div>
    </form>
    {% else %}
    <div class="text-center py-16">
        <p class="text-gray-500 text-lg">–ù–µ—Ç —Å–º–µ–Ω –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å.</p>
    </div>
    {% endif %}
</div>

<script>
function confirmDelete(shiftId) {
    Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É?',
        text: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/staff/shifts/${shiftId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`shift-${shiftId}`).remove();
                    Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', data.message, 'success');
                } else {
                    Swal.fire('–û—à–∏–±–∫–∞!', data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–º–µ–Ω—É.', 'error');
                }
            });
        }
    });
}

function duplicateShift(shiftId) {
    fetch(`/staff/shifts/${shiftId}/duplicate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
        console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
        if (data.success && data.new_shift_html) {
            const parser = new DOMParser();
            const newBlock = parser.parseFromString(data.new_shift_html, 'text/html').body.firstChild;

            const container = document.getElementById('shift-container');
            if (!container) {
                Swal.fire('–û—à–∏–±–∫–∞!', '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–º–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.', 'error');
                return;
            }

            container.appendChild(newBlock);
            // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫ –Ω–æ–≤—ã–º —Å–µ–ª–µ–∫—Ç–∞–º
            attachStaffValidation();
            Swal.fire('–£—Å–ø–µ—à–Ω–æ!', '–°–º–µ–Ω–∞ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∞.', 'success');
        } else if (data.success) {
            Swal.fire('–£—Å–ø–µ—à–Ω–æ!', '–°–º–µ–Ω–∞ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∞.', 'success');
        } else {
            Swal.fire('–û—à–∏–±–∫–∞!', data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏.', 'error');
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// -------------------------
// –í–∞–ª–∏–¥–∞—Ü–∏—è: –æ–¥–∏–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ ‚Äî –æ–¥–Ω–∞ —Ä–æ–ª—å
// -------------------------
function attachStaffValidation() {
    // –ù–∞–π–¥–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã, –≥–¥–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫.
    const staffSelects = document.querySelectorAll('#shift-container select[name*="staff"]');

    staffSelects.forEach(select => {
        // –ò–∑–±–µ–≥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏—è
        if (select.dataset.validationAttached) return;

        select.addEventListener('change', function() {
            const allSelects = Array.from(document.querySelectorAll('#shift-container select[name*="staff"]'));
            const chosen = this.value; // id —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
            if (!chosen) return; // –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º

            // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ –≤—ã–±—Ä–∞–ª –ª–∏ –∫—Ç–æ-—Ç–æ —É–∂–µ —Ç–æ—Ç –∂–µ id
            const duplicates = allSelects.filter(s => s !== this && s.value === chosen);
            if (duplicates.length > 0) {
                Swal.fire({
                    icon: 'error',
                    title: '–ù–µ–≤–µ—Ä–Ω–æ',
                    text: '–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω —Å—Ä–∞–∑—É –Ω–∞ –¥–≤–µ —Ä–∞–∑–Ω—ã–µ —Ä–æ–ª–∏.'
                }).then(() => {
                    // –°–±—Ä–æ—Å–∏–º –≤—ã–±–æ—Ä –≤ —Ç–µ–∫—É—â–µ–º —Å–µ–ª–µ–∫—Ç–µ
                    this.value = "";
                });
            }
        });

        select.dataset.validationAttached = "true";
    });
}

document.addEventListener('DOMContentLoaded', () => {
    // –ü—Ä–∏–≤—è–∂–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    attachStaffValidation();
});
</script>
{% endblock %}
